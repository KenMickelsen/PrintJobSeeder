<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Job Seeder - Vasion Output</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        header h1 {
            color: #00d9ff;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        header p {
            color: #888;
            font-size: 1.1em;
        }

        .card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .card h2 {
            color: #00d9ff;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #bbb;
            font-weight: 500;
        }

        .form-group label .hint {
            font-weight: normal;
            color: #666;
            font-size: 0.9em;
        }

        input[type="text"],
        input[type="number"],
        input[type="url"],
        input[type="password"],
        textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input:focus,
        textarea:focus {
            outline: none;
            border-color: #00d9ff;
            box-shadow: 0 0 0 3px rgba(0, 217, 255, 0.1);
        }

        textarea {
            min-height: 80px;
            resize: vertical;
            font-family: monospace;
        }

        input[type="file"] {
            padding: 10px;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.2);
            color: #fff;
            width: 100%;
            cursor: pointer;
        }

        input[type="file"]:hover {
            border-color: #00d9ff;
        }

        .btn-primary {
            background: linear-gradient(135deg, #00d9ff, #0099cc);
            color: #fff;
            border: none;
            padding: 15px 40px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 217, 255, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .button-row {
            display: flex;
            gap: 15px;
        }

        .button-row .btn-primary {
            flex: 1;
        }

        .btn-stop {
            background: linear-gradient(135deg, #ff4757, #c0392b);
            color: #fff;
            border: none;
            padding: 15px 30px;
            font-size: 1.1em;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            white-space: nowrap;
        }

        .btn-stop:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 71, 87, 0.4);
        }

        .btn-stop:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .row, .row-3 {
                grid-template-columns: 1fr;
            }
        }

        /* Industry Selection */
        .industry-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .industry-checkbox {
            display: none;
        }

        .industry-label {
            padding: 12px 20px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1em;
            user-select: none;
        }

        .industry-label:hover {
            border-color: #00d9ff;
            background: rgba(0, 217, 255, 0.1);
        }

        .industry-checkbox:checked + .industry-label {
            border-color: #00d9ff;
            background: #00d9ff;
            color: #1a1a2e;
            font-weight: 600;
        }

        /* Tabs */
        .tabs-container {
            margin-top: 20px;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 0;
        }

        .tab-btn {
            padding: 12px 24px;
            background: transparent;
            border: none;
            color: #888;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }

        .tab-btn:hover {
            color: #fff;
            background: rgba(255, 255, 255, 0.05);
        }

        .tab-btn.active {
            color: #00d9ff;
            border-bottom-color: #00d9ff;
            background: rgba(0, 217, 255, 0.1);
        }

        .tab-content {
            display: none;
            padding: 20px 0;
        }

        .tab-content.active {
            display: block;
        }

        .no-industries-message {
            text-align: center;
            padding: 40px;
            color: #666;
            font-style: italic;
        }

        /* Toggle switch styles */
        .toggle-switch {
            display: inline-flex;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 25px;
            padding: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .toggle-option {
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            color: #888;
            font-weight: 500;
            font-size: 0.9em;
        }

        .toggle-option.active {
            background: #00d9ff;
            color: #1a1a2e;
        }

        .toggle-option:hover:not(.active) {
            color: #fff;
        }

        /* Preset buttons */
        .preset-btn {
            padding: 6px 14px;
            border: 1px solid rgba(0, 217, 255, 0.5);
            border-radius: 15px;
            background: rgba(0, 217, 255, 0.1);
            color: #00d9ff;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .preset-btn:hover {
            background: rgba(0, 217, 255, 0.2);
            border-color: #00d9ff;
        }

        .preset-btn.active {
            background: #00d9ff;
            color: #1a1a2e;
        }

        /* Timing section */
        .timing-options {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .timing-options.active {
            display: block;
        }

        .timing-description {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
        }

        /* Progress styles */
        .progress-container {
            display: none;
            margin-top: 20px;
        }

        .progress-container.visible {
            display: block;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d9ff, #00ff88);
            border-radius: 4px;
            transition: width 0.3s;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            color: #888;
            margin-bottom: 20px;
        }

        .results-log {
            max-height: 400px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 0.85em;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 5px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .log-entry.success {
            background: rgba(0, 255, 136, 0.1);
            border-left: 3px solid #00ff88;
        }

        .log-entry.error {
            background: rgba(255, 68, 68, 0.1);
            border-left: 3px solid #ff4444;
        }

        .log-entry.pending {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #666;
        }

        .log-entry .job-num {
            color: #00d9ff;
            font-weight: bold;
            min-width: 60px;
        }

        .log-entry .industry-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8em;
            background: rgba(255, 255, 255, 0.1);
            min-width: 90px;
            text-align: center;
        }

        .log-entry .details {
            flex: 1;
            color: #aaa;
        }

        .log-entry .status-icon {
            font-size: 1.2em;
        }

        .log-entry .error-response {
            display: block;
            width: 100%;
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(255, 71, 87, 0.15);
            border: 1px solid rgba(255, 71, 87, 0.3);
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.85em;
            color: #ff9999;
            white-space: pre-wrap;
            word-break: break-word;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-entry.error {
            flex-wrap: wrap;
        }

        .summary {
            margin-top: 20px;
            padding: 15px;
            background: rgba(0, 217, 255, 0.1);
            border-radius: 8px;
            text-align: center;
            display: none;
        }

        .summary.visible {
            display: block;
        }

        .summary.success {
            background: rgba(0, 255, 136, 0.1);
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .summary.partial {
            background: rgba(255, 200, 0, 0.1);
            border: 1px solid rgba(255, 200, 0, 0.3);
        }

        .summary.error {
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
        }

        .error-message {
            color: #ff4444;
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 68, 68, 0.1);
            border-radius: 4px;
            display: none;
        }

        .error-message.visible {
            display: block;
        }

        /* Page range */
        .page-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .page-range .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .page-range span {
            color: #888;
        }

        /* Section within tab */
        .tab-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .tab-section h3 {
            color: #00d9ff;
            font-size: 1.1em;
            margin-bottom: 15px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 217, 255, 0.3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 217, 255, 0.5);
        }

        .pdf-source-section {
            display: none;
            margin-top: 15px;
        }

        .pdf-source-section.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üñ®Ô∏è Print Job Seeder</h1>
            <p>Send bulk print jobs to Vasion Output API with industry-specific metadata</p>
        </header>

        <form id="jobForm" enctype="multipart/form-data">
            <!-- Global Settings -->
            <div class="card">
                <h2>üîó API Configuration</h2>
                <div class="row">
                    <div class="form-group">
                        <label>API URL <span class="hint">(include http:// or https://)</span></label>
                        <input type="url" id="url" name="url" placeholder="https://external-api.app.printercloudnow.com/v1/print" required>
                    </div>
                    <div class="form-group">
                        <label>Bearer Token / API Key <span class="hint">(optional)</span></label>
                        <input type="password" id="bearer_token" name="bearer_token" placeholder="your-api-key-here">
                    </div>
                </div>
            </div>

            <!-- Timing Settings -->
            <div class="card">
                <h2>‚è±Ô∏è Timing Settings</h2>
                <div class="form-group">
                    <label>Delay Between Jobs</label>
                    <div class="toggle-switch">
                        <div class="toggle-option timing-toggle active" data-mode="fixed">Fixed Delay</div>
                        <div class="toggle-option timing-toggle" data-mode="random">Natural/Random</div>
                    </div>
                    <input type="hidden" id="timing_mode" name="timing_mode" value="fixed">
                </div>

                <!-- Fixed delay options -->
                <div class="timing-options active" id="fixed-timing">
                    <div class="timing-description">
                        Jobs will be sent with a consistent delay between each one.
                    </div>
                    <div class="form-group" style="max-width: 200px; margin-bottom: 0;">
                        <label>Delay (seconds)</label>
                        <input type="number" id="fixed_delay" name="fixed_delay" value="1" min="0.1" max="300" step="0.1">
                    </div>
                </div>

                <!-- Random delay options -->
                <div class="timing-options" id="random-timing">
                    <div class="timing-description">
                        Jobs will be sent with randomized delays to simulate natural user behavior. 
                        Some jobs come in quick bursts (0.5-3 seconds), some have moderate gaps (3-30 seconds), 
                        and occasionally there are longer pauses (30+ seconds).
                    </div>
                    <div class="row">
                        <div class="form-group">
                            <label>Minimum Delay (seconds)</label>
                            <input type="number" id="min_delay" name="min_delay" value="0.5" min="0.1" max="60" step="0.1">
                        </div>
                        <div class="form-group">
                            <label>Maximum Delay (seconds)</label>
                            <input type="number" id="max_delay" name="max_delay" value="120" min="1" max="600" step="1">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Industry Selection -->
            <div class="card">
                <h2>üè¢ Select Industries</h2>
                <p style="color: #888; margin-bottom: 15px;">Choose which industries you want to send print jobs for. Each selected industry will have its own configuration tab.</p>
                
                <div class="industry-selector">
                    {% for industry in industries %}
                    <input type="checkbox" class="industry-checkbox" id="ind_{{ industry }}" data-industry="{{ industry }}">
                    <label class="industry-label" for="ind_{{ industry }}">{{ industry_names[industry] }}</label>
                    {% endfor %}
                </div>

                <!-- Industry Tabs -->
                <div class="tabs-container" id="industryTabs">
                    <div class="tab-buttons" id="tabButtons">
                        <!-- Tab buttons will be added dynamically -->
                    </div>
                    
                    <div id="tabContents">
                        <div class="no-industries-message">
                            üëÜ Select one or more industries above to configure print jobs
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit -->
            <div class="card">
                <div class="button-row">
                    <button type="submit" class="btn-primary" id="submitBtn">üöÄ Send Print Jobs</button>
                    <button type="button" class="btn-stop" id="stopBtn" style="display: none;">‚èπÔ∏è Stop Jobs</button>
                </div>
                
                <div class="error-message" id="errorMessage"></div>

                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar">
                        <div class="progress-bar-fill" id="progressFill"></div>
                    </div>
                    <div class="progress-text" id="progressText">Preparing to send jobs...</div>
                    
                    <div class="results-log" id="resultsLog"></div>
                    
                    <div class="summary" id="summary"></div>
                </div>
            </div>
        </form>
    </div>

    <script>
        // Industry presets passed from Flask
        const presets = {{ presets | tojson | safe }};
        const usernamePresets = {{ username_presets | tojson | safe }};
        const industries = {{ industries | tojson | safe }};
        const industryNames = {{ industry_names | tojson | safe }};

        // Track active industries
        let activeIndustries = new Set();
        
        // Current session tracking
        let currentSessionId = null;
        let currentEventSource = null;

        // Check for existing session on page load
        async function checkExistingSession() {
            const savedSessionId = localStorage.getItem('printJobSeeder_sessionId');
            if (!savedSessionId) return;
            
            try {
                const response = await fetch(`/api/session-status/${savedSessionId}`);
                if (!response.ok) {
                    localStorage.removeItem('printJobSeeder_sessionId');
                    return;
                }
                
                const data = await response.json();
                if (!data.success) {
                    localStorage.removeItem('printJobSeeder_sessionId');
                    return;
                }
                
                // Restore session state
                currentSessionId = savedSessionId;
                const progressContainer = document.getElementById('progressContainer');
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');
                const resultsLog = document.getElementById('resultsLog');
                const summary = document.getElementById('summary');
                const submitBtn = document.getElementById('submitBtn');
                const stopBtn = document.getElementById('stopBtn');
                
                // Show progress container
                progressContainer.classList.add('visible');
                
                // Restore previous results
                resultsLog.innerHTML = '';
                data.results.slice().reverse().forEach(result => {
                    const statusClass = result.success ? 'success' : 'error';
                    const statusIcon = result.success ? '‚úÖ' : '‚ùå';
                    const industryDisplay = industryNames[result.industry] || result.industry;
                    
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry ${statusClass}`;
                    let errorResponseHtml = '';
                    if (!result.success && result.response) {
                        errorResponseHtml = `<div class="error-response">${escapeHtml(result.response)}</div>`;
                    }
                    logEntry.innerHTML = `
                        <span class="job-num">Job ${result.job_number}</span>
                        <span class="industry-badge">${industryDisplay}</span>
                        <span class="details">
                            ${result.filename} ‚Üí ${result.printer} (${result.username})
                            ${result.status_code ? `[${result.status_code}]` : ''}
                        </span>
                        <span class="status-icon">${statusIcon}</span>
                        ${errorResponseHtml}
                    `;
                    resultsLog.appendChild(logEntry);
                });
                
                const progress = (data.completed / data.total) * 100;
                progressFill.style.width = `${progress}%`;
                
                if (data.status === 'complete') {
                    const successCount = data.results.filter(r => r.success).length;
                    const failCount = data.total - successCount;
                    
                    summary.classList.add('visible');
                    if (failCount === 0) {
                        summary.classList.add('success');
                        summary.innerHTML = `‚úÖ All ${successCount} jobs sent successfully!`;
                    } else if (successCount === 0) {
                        summary.classList.add('error');
                        summary.innerHTML = `‚ùå All ${failCount} jobs failed.`;
                    } else {
                        summary.classList.add('partial');
                        summary.innerHTML = `‚ö†Ô∏è ${successCount} succeeded, ${failCount} failed.`;
                    }
                    progressText.textContent = 'Complete!';
                    localStorage.removeItem('printJobSeeder_sessionId');
                    
                } else if (data.status === 'stopped') {
                    const successCount = data.results.filter(r => r.success).length;
                    summary.classList.add('visible', 'partial');
                    summary.innerHTML = `‚èπÔ∏è Stopped: ${successCount}/${data.completed} jobs sent successfully (${data.total - data.completed} skipped)`;
                    progressText.textContent = 'Stopped';
                    localStorage.removeItem('printJobSeeder_sessionId');
                    
                } else if (data.status === 'running' || data.status === 'ready') {
                    // Session is still running - reconnect to stream
                    submitBtn.disabled = true;
                    submitBtn.textContent = '‚è≥ Sending Jobs...';
                    stopBtn.style.display = 'block';
                    
                    const successCount = data.results.filter(r => r.success).length;
                    progressText.textContent = `Reconnecting... Sent ${data.completed}/${data.total} jobs (${successCount} successful)`;
                    
                    // Reconnect to SSE stream
                    connectToStream(savedSessionId, data.total, data.completed, successCount);
                }
                
            } catch (error) {
                console.error('Error checking session:', error);
                localStorage.removeItem('printJobSeeder_sessionId');
            }
        }
        
        // Connect to SSE stream
        function connectToStream(sessionId, totalJobs, startCompleted = 0, startSuccess = 0) {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const resultsLog = document.getElementById('resultsLog');
            const summary = document.getElementById('summary');
            const submitBtn = document.getElementById('submitBtn');
            const stopBtn = document.getElementById('stopBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            let successCount = startSuccess;
            let completedCount = startCompleted;
            
            currentEventSource = new EventSource(`/api/stream-jobs/${sessionId}`);
            
            currentEventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.error) {
                    currentEventSource.close();
                    currentEventSource = null;
                    errorMessage.textContent = `Error: ${data.error}`;
                    errorMessage.classList.add('visible');
                    resetButtons();
                    return;
                }
                
                if (data.type === 'job_result') {
                    const result = data.result;
                    completedCount = result.job_number;
                    if (result.success) successCount++;
                    
                    const statusClass = result.success ? 'success' : 'error';
                    const statusIcon = result.success ? '‚úÖ' : '‚ùå';
                    const industryDisplay = industryNames[result.industry] || result.industry;
                    
                    // Add new log entry at the top
                    const logEntry = document.createElement('div');
                    logEntry.className = `log-entry ${statusClass}`;
                    let errorResponseHtml = '';
                    if (!result.success && result.response) {
                        errorResponseHtml = `<div class="error-response">${escapeHtml(result.response)}</div>`;
                    }
                    logEntry.innerHTML = `
                        <span class="job-num">Job ${result.job_number}</span>
                        <span class="industry-badge">${industryDisplay}</span>
                        <span class="details">
                            ${result.filename} ‚Üí ${result.printer} (${result.username})
                            ${result.status_code ? `[${result.status_code}]` : ''}
                        </span>
                        <span class="status-icon">${statusIcon}</span>
                        ${errorResponseHtml}
                    `;
                    resultsLog.insertBefore(logEntry, resultsLog.firstChild);
                    
                    // Update progress
                    progressFill.style.width = `${data.progress}%`;
                    progressText.textContent = `Sent ${completedCount}/${totalJobs} jobs (${successCount} successful)`;
                }
                else if (data.type === 'delay') {
                    progressText.textContent = `Waiting ${data.seconds}s before next job... (${completedCount}/${totalJobs} sent)`;
                }
                else if (data.type === 'stopped') {
                    currentEventSource.close();
                    currentEventSource = null;
                    currentSessionId = null;
                    localStorage.removeItem('printJobSeeder_sessionId');
                    
                    summary.classList.add('visible', 'partial');
                    summary.innerHTML = `‚èπÔ∏è Stopped: ${data.success_count}/${data.completed} jobs sent successfully (${data.total - data.completed} skipped)`;
                    progressText.textContent = 'Stopped';
                    resetButtons();
                }
                else if (data.type === 'complete') {
                    currentEventSource.close();
                    currentEventSource = null;
                    currentSessionId = null;
                    localStorage.removeItem('printJobSeeder_sessionId');
                    
                    const failCount = totalJobs - data.success_count;
                    
                    summary.classList.add('visible');
                    if (failCount === 0) {
                        summary.classList.add('success');
                        summary.innerHTML = `‚úÖ All ${data.success_count} jobs sent successfully!`;
                    } else if (data.success_count === 0) {
                        summary.classList.add('error');
                        summary.innerHTML = `‚ùå All ${failCount} jobs failed.`;
                    } else {
                        summary.classList.add('partial');
                        summary.innerHTML = `‚ö†Ô∏è ${data.success_count} succeeded, ${failCount} failed.`;
                    }
                    
                    progressText.textContent = 'Complete!';
                    progressFill.style.width = '100%';
                    resetButtons();
                }
            };
            
            currentEventSource.onerror = function(error) {
                currentEventSource.close();
                currentEventSource = null;
                // Only show error if we haven't completed
                if (completedCount < totalJobs) {
                    errorMessage.textContent = 'Connection lost. Refresh the page to check session status.';
                    errorMessage.classList.add('visible');
                }
                resetButtons();
            };
        }
        
        function resetButtons() {
            const submitBtn = document.getElementById('submitBtn');
            const stopBtn = document.getElementById('stopBtn');
            submitBtn.disabled = false;
            submitBtn.textContent = 'üöÄ Send Print Jobs';
            stopBtn.style.display = 'none';
        }
        
        // Escape HTML to prevent XSS from response content
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Stop button handler
        document.getElementById('stopBtn').addEventListener('click', async () => {
            if (!currentSessionId) return;
            
            const stopBtn = document.getElementById('stopBtn');
            stopBtn.disabled = true;
            stopBtn.textContent = '‚è≥ Stopping...';
            
            try {
                const response = await fetch(`/api/stop-jobs/${currentSessionId}`, {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    throw new Error('Failed to stop jobs');
                }
                
            } catch (error) {
                console.error('Error stopping jobs:', error);
                stopBtn.disabled = false;
                stopBtn.textContent = '‚èπÔ∏è Stop Jobs';
            }
        });
        
        // Initialize on page load
        checkExistingSession();

        // Generate tab content template for an industry
        function createTabContent(industry) {
            const displayName = industryNames[industry];
            return `
                <div class="tab-content" id="tab-${industry}" data-industry="${industry}">
                    <!-- PDF Source -->
                    <div class="tab-section">
                        <h3>üìÑ Document Source</h3>
                        <div class="form-group">
                            <label>PDF Source</label>
                            <div class="toggle-switch">
                                <div class="toggle-option pdf-toggle active" data-industry="${industry}" data-source="generate">‚ö° Generate PDF</div>
                                <div class="toggle-option pdf-toggle" data-industry="${industry}" data-source="upload">üìÅ Upload PDF</div>
                            </div>
                        </div>

                        <!-- Generate options -->
                        <div class="pdf-source-section active" id="generate-section-${industry}">
                            <div class="page-range">
                                <div class="form-group">
                                    <label>Min Pages</label>
                                    <input type="number" class="min-pages" data-industry="${industry}" value="1" min="1" max="15">
                                </div>
                                <span>to</span>
                                <div class="form-group">
                                    <label>Max Pages</label>
                                    <input type="number" class="max-pages" data-industry="${industry}" value="15" min="1" max="15">
                                </div>
                            </div>
                            <p style="color: #666; font-size: 0.85em; margin-top: 10px;">
                                üí° Each job will generate a unique PDF with ${displayName.replace(/[^a-zA-Z ]/g, '')}-specific content.
                            </p>
                        </div>

                        <!-- Upload options -->
                        <div class="pdf-source-section" id="upload-section-${industry}">
                            <div class="form-group">
                                <label>PDF File</label>
                                <input type="file" class="file-upload" data-industry="${industry}" accept=".pdf">
                            </div>
                        </div>
                    </div>

                    <!-- Filenames -->
                    <div class="tab-section">
                        <h3>üìù Filenames</h3>
                        <div class="form-group">
                            <button type="button" class="preset-btn use-preset-filenames" data-industry="${industry}">
                                Use ${displayName} Preset
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Filenames <span class="hint">(comma-separated)</span></label>
                            <textarea class="filenames-input" data-industry="${industry}" placeholder="Enter filenames or use preset above..."></textarea>
                        </div>
                    </div>

                    <!-- Usernames -->
                    <div class="tab-section">
                        <h3>üë• Usernames</h3>
                        <div class="form-group">
                            <button type="button" class="preset-btn use-preset-usernames" data-industry="${industry}">
                                Use ${displayName} Preset
                            </button>
                        </div>
                        <div class="form-group">
                            <label>Usernames <span class="hint">(comma-separated)</span></label>
                            <textarea class="usernames-input" data-industry="${industry}" placeholder="Enter usernames or use preset above..."></textarea>
                        </div>
                    </div>

                    <!-- Printers -->
                    <div class="tab-section">
                        <h3>üñ®Ô∏è Printers</h3>
                        <div class="form-group">
                            <label>Printer Names <span class="hint">(comma-separated, must match Vasion printer names)</span></label>
                            <textarea class="printers-input" data-industry="${industry}" placeholder="HP Office, Canon Lobby, Xerox Dept A"></textarea>
                        </div>
                    </div>

                    <!-- Job Count -->
                    <div class="tab-section">
                        <h3>üî¢ Number of Jobs</h3>
                        <div class="form-group" style="max-width: 200px;">
                            <label>Jobs for ${displayName}</label>
                            <input type="number" class="num-jobs" data-industry="${industry}" value="10" min="1" max="1000">
                        </div>
                    </div>
                </div>
            `;
        }

        // Update tabs when industries are selected/deselected
        function updateTabs() {
            const tabButtons = document.getElementById('tabButtons');
            const tabContents = document.getElementById('tabContents');
            
            // Clear existing content
            tabButtons.innerHTML = '';
            
            // Remove old tab contents but keep the no-industries message structure
            const oldTabs = tabContents.querySelectorAll('.tab-content');
            oldTabs.forEach(tab => tab.remove());
            
            if (activeIndustries.size === 0) {
                tabContents.innerHTML = '<div class="no-industries-message">üëÜ Select one or more industries above to configure print jobs</div>';
                return;
            }
            
            // Remove no-industries message
            const noMsg = tabContents.querySelector('.no-industries-message');
            if (noMsg) noMsg.remove();
            
            let isFirst = true;
            activeIndustries.forEach(industry => {
                // Create tab button
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = `tab-btn${isFirst ? ' active' : ''}`;
                btn.dataset.industry = industry;
                btn.textContent = industryNames[industry];
                btn.addEventListener('click', () => switchTab(industry));
                tabButtons.appendChild(btn);
                
                // Create tab content
                tabContents.insertAdjacentHTML('beforeend', createTabContent(industry));
                const tabContent = document.getElementById(`tab-${industry}`);
                if (isFirst) {
                    tabContent.classList.add('active');
                }
                
                isFirst = false;
            });
            
            // Attach event listeners for the new tab content
            attachTabEventListeners();
        }

        // Switch between tabs
        function switchTab(industry) {
            // Update button states
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.industry === industry);
            });
            
            // Update content visibility
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.dataset.industry === industry);
            });
        }

        // Attach event listeners for tab content elements
        function attachTabEventListeners() {
            // PDF source toggle
            document.querySelectorAll('.pdf-toggle').forEach(toggle => {
                toggle.addEventListener('click', () => {
                    const industry = toggle.dataset.industry;
                    const source = toggle.dataset.source;
                    
                    // Update toggle UI
                    document.querySelectorAll(`.pdf-toggle[data-industry="${industry}"]`).forEach(t => {
                        t.classList.toggle('active', t.dataset.source === source);
                    });
                    
                    // Show/hide sections
                    document.getElementById(`generate-section-${industry}`).classList.toggle('active', source === 'generate');
                    document.getElementById(`upload-section-${industry}`).classList.toggle('active', source === 'upload');
                });
            });
            
            // Filename preset buttons
            document.querySelectorAll('.use-preset-filenames').forEach(btn => {
                btn.addEventListener('click', () => {
                    const industry = btn.dataset.industry;
                    const textarea = document.querySelector(`.filenames-input[data-industry="${industry}"]`);
                    textarea.value = presets[industry].join(', ');
                });
            });
            
            // Username preset buttons
            document.querySelectorAll('.use-preset-usernames').forEach(btn => {
                btn.addEventListener('click', () => {
                    const industry = btn.dataset.industry;
                    const textarea = document.querySelector(`.usernames-input[data-industry="${industry}"]`);
                    textarea.value = usernamePresets[industry].join(', ');
                });
            });
        }

        // Industry checkbox handlers
        document.querySelectorAll('.industry-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const industry = checkbox.dataset.industry;
                if (checkbox.checked) {
                    activeIndustries.add(industry);
                } else {
                    activeIndustries.delete(industry);
                }
                updateTabs();
            });
        });

        // Timing toggle handlers
        document.querySelectorAll('.timing-toggle').forEach(toggle => {
            toggle.addEventListener('click', () => {
                const mode = toggle.dataset.mode;
                
                // Update toggle UI
                document.querySelectorAll('.timing-toggle').forEach(t => {
                    t.classList.toggle('active', t.dataset.mode === mode);
                });
                
                // Update hidden input
                document.getElementById('timing_mode').value = mode;
                
                // Show/hide timing options
                document.getElementById('fixed-timing').classList.toggle('active', mode === 'fixed');
                document.getElementById('random-timing').classList.toggle('active', mode === 'random');
            });
        });

        // Collect industry configurations
        function getIndustryConfigs() {
            const configs = {};
            
            activeIndustries.forEach(industry => {
                const tabContent = document.getElementById(`tab-${industry}`);
                if (!tabContent) return;
                
                // Determine PDF source
                const generateToggle = tabContent.querySelector(`.pdf-toggle[data-source="generate"]`);
                const pdfSource = generateToggle && generateToggle.classList.contains('active') ? 'generate' : 'upload';
                
                configs[industry] = {
                    pdf_source: pdfSource,
                    min_pages: tabContent.querySelector('.min-pages').value,
                    max_pages: tabContent.querySelector('.max-pages').value,
                    filenames: tabContent.querySelector('.filenames-input').value,
                    usernames: tabContent.querySelector('.usernames-input').value,
                    printers: tabContent.querySelector('.printers-input').value,
                    num_jobs: tabContent.querySelector('.num-jobs').value
                };
            });
            
            return configs;
        }

        // Form submission
        document.getElementById('jobForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const resultsLog = document.getElementById('resultsLog');
            const summary = document.getElementById('summary');
            const errorMessage = document.getElementById('errorMessage');
            
            // Validate
            if (activeIndustries.size === 0) {
                errorMessage.textContent = 'Error: Please select at least one industry.';
                errorMessage.classList.add('visible');
                return;
            }
            
            const industryConfigs = getIndustryConfigs();
            
            // Validate each industry config
            for (const [industry, config] of Object.entries(industryConfigs)) {
                if (!config.filenames.trim()) {
                    errorMessage.textContent = `Error: ${industryNames[industry]} - Please enter filenames or use the preset.`;
                    errorMessage.classList.add('visible');
                    return;
                }
                if (!config.usernames.trim()) {
                    errorMessage.textContent = `Error: ${industryNames[industry]} - Please enter usernames or use the preset.`;
                    errorMessage.classList.add('visible');
                    return;
                }
                if (!config.printers.trim()) {
                    errorMessage.textContent = `Error: ${industryNames[industry]} - Please enter printer names.`;
                    errorMessage.classList.add('visible');
                    return;
                }
                
                // Check file upload if needed
                if (config.pdf_source === 'upload') {
                    const fileInput = document.querySelector(`.file-upload[data-industry="${industry}"]`);
                    if (!fileInput.files || fileInput.files.length === 0) {
                        errorMessage.textContent = `Error: ${industryNames[industry]} - Please upload a PDF file.`;
                        errorMessage.classList.add('visible');
                        return;
                    }
                }
            }
            
            // Reset UI
            errorMessage.classList.remove('visible');
            submitBtn.disabled = true;
            submitBtn.textContent = '‚è≥ Sending Jobs...';
            progressContainer.classList.add('visible');
            progressFill.style.width = '0%';
            resultsLog.innerHTML = '';
            summary.classList.remove('visible', 'success', 'partial', 'error');
            
            // Calculate total jobs
            let totalJobs = 0;
            for (const config of Object.values(industryConfigs)) {
                totalJobs += parseInt(config.num_jobs) || 0;
            }
            
            progressText.textContent = `Preparing to send ${totalJobs} job(s) across ${activeIndustries.size} industry(ies)...`;
            
            // Prepare form data
            const formData = new FormData();
            formData.append('url', document.getElementById('url').value);
            formData.append('bearer_token', document.getElementById('bearer_token').value);
            formData.append('timing_mode', document.getElementById('timing_mode').value);
            formData.append('fixed_delay', document.getElementById('fixed_delay').value);
            formData.append('min_delay', document.getElementById('min_delay').value);
            formData.append('max_delay', document.getElementById('max_delay').value);
            formData.append('industry_configs', JSON.stringify(industryConfigs));
            
            // Add files for upload industries
            activeIndustries.forEach(industry => {
                const config = industryConfigs[industry];
                if (config.pdf_source === 'upload') {
                    const fileInput = document.querySelector(`.file-upload[data-industry="${industry}"]`);
                    if (fileInput.files.length > 0) {
                        formData.append(`file_${industry}`, fileInput.files[0]);
                    }
                }
            });
            
            try {
                // Step 1: Start the job session
                const startResponse = await fetch('/api/start-jobs', {
                    method: 'POST',
                    body: formData
                });
                
                const startData = await startResponse.json();
                
                if (!startResponse.ok || !startData.success) {
                    throw new Error(startData.error || 'Failed to start jobs');
                }
                
                const sessionId = startData.session_id;
                currentSessionId = sessionId;
                totalJobs = startData.total_jobs;
                
                // Save session ID for reconnection
                localStorage.setItem('printJobSeeder_sessionId', sessionId);
                
                progressText.textContent = `Starting ${totalJobs} job(s)...`;
                
                // Show stop button
                const stopBtn = document.getElementById('stopBtn');
                stopBtn.style.display = 'block';
                stopBtn.disabled = false;
                stopBtn.textContent = '‚èπÔ∏è Stop Jobs';
                
                // Connect to SSE stream for real-time updates
                connectToStream(sessionId, totalJobs);
                
            } catch (error) {
                errorMessage.textContent = `Error: ${error.message}`;
                errorMessage.classList.add('visible');
                progressContainer.classList.remove('visible');
                submitBtn.disabled = false;
                submitBtn.textContent = 'üöÄ Send Print Jobs';
            }
        });
    </script>
</body>
</html>
